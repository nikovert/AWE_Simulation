% Copyright (C) 2021  Nikolaus Vertovec
% 
%     This program is free software: you can redistribute it and/or modify
%     it under the terms of the GNU General Public License as published by
%     the Free Software Foundation, either version 3 of the License, or
%     (at your option) any later version.
% 
%     This program is distributed in the hope that it will be useful,
%     but WITHOUT ANY WARRANTY; without even the implied warranty of
%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%     GNU General Public License for more details.
%
% :Revision: 14-December-2021
% :Author: Nikolaus Vertovec (nikolaus.vertovec@eng.ox.ac.uk)

%% Add relevant files to path
addpath('../')
addToolbox;
onlysimple = true;
%% Setup Parameters
h = 200;
s = 11*pi/17;
sigma = 30;
[long, lat, t_tau, t_rot_tau, t_W, t_rot_W] = getLongLat(s, sigma, h);
[x, y, z] = sph2cart(long, lat, h);

%% Figure handlers
% Create figure
figure1 = figure('WindowState','maximized');

% Create axes
axes1 = axes('Parent',figure1);
axis off
hold(axes1,'on');

%% Plot point
plot3(x,y,z,'ko','MarkerSize',10,'MarkerFaceColor','k')
axis([0, h, -h, h, 0, h])
xlabel('X','Visible','off')
ylabel('Y','Visible','off')
zlabel('Z','Visible','off')
hold on

%% Draw lines to point
syms r j
xr = r .* cos(lat) .* cos(long);
yr = r .* cos(lat) .* sin(long);
zr = r .* sin(lat);
fplot3(xr,yr,zr,[0 h],'k', 'LineWidth', 2, 'Parent',axes1)
%fplot3(xr,yr,sym(0),[0 h],'k--', 'LineWidth', 2, 'Parent',axes1)
%fplot3(xr,yr,sym(z),[0 h],'k--', 'LineWidth', 2, 'Parent',axes1)
%fplot3(sym(x),sym(y),h*sin(j),[0 lat],'k--', 'LineWidth', 2, 'Parent',axes1)

%% Plot Sphere and Axis
[X,Y,Z] = sphere(55);
surf(X*h,Y*h,Z*h, 'FaceAlpha', 0.15, 'EdgeColor', [0.741176470588235 0.733333333333333 0.733333333333333], ...
    'FaceColor','none','LineStyle', '--', 'Parent',axes1)
line([0 0], [0 0], [h 0],'Color','red','LineStyle','--', 'Parent',axes1,'LineWidth', 2)
line([0 0], [h -h], [0 0],'Color','red','LineStyle','--', 'Parent',axes1,'LineWidth', 2)
line([h 0], [0 0], [0 0],'Color','red','LineStyle','--', 'Parent',axes1,'LineWidth', 2)

%% Add long-lat description
syms j t
xa = h*cos(j)*cos(t);
ya = h*cos(j)*sin(t);
fsurf(xa,ya,0,[0 lat 0 long],'FaceColor','b','EdgeColor','none', 'FaceAlpha', 0.15, 'Parent',axes1)
syms u v
xp = u*cos(v)*cos(long);
yp = u*cos(v)*sin(long);
zp = u*sin(v);
fsurf(xp,yp,zp,[0 h 0 lat],'FaceColor','g','EdgeColor','none', 'FaceAlpha', 0.15, 'Parent',axes1)

%% Plot curve
% Parameters
h_tau       = h;
Lem.a       = 120/h_tau;
Lem.b       = 200/h_tau;
Lem.phi0    = 1;

M_WP = [cos(Lem.phi0),0, -sin(Lem.phi0);0, 1, 0; sin(Lem.phi0),0, cos(Lem.phi0)];

long_curve = @(s) Lem.b .* sin(s) ./( 1+(Lem.a/Lem.b .* cos(s)).^2 );
lat_curve  = @(s) Lem.a .* sin(s).*cos(s) ./ ( 1+(Lem.a/Lem.b .* cos(s)).^2 );

% Plot curve
num_samples = 200;
s_range = linspace(0,2*pi, num_samples);
[x_curve, y_curve, z_curve] = sph2cart(long_curve(s_range), lat_curve(s_range), h_tau);
curve_cart = M_WP * [x_curve; y_curve; z_curve];
curve_color = [0.501960784313725 0.501960784313725 0.501960784313725];
if ~onlysimple
    scatter3(curve_cart(1,:), curve_cart(2,:), curve_cart(3,:),20,'filled','MarkerEdgeColor','none',...
        'MarkerFaceColor',curve_color)
end

% Plot segment
num_samples = floor(1000 * s/2*pi);
s_range = linspace(0,s, num_samples);
[x_curve, y_curve, z_curve] = sph2cart(long_curve(s_range), lat_curve(s_range), h_tau);
curve_cart = M_WP * [x_curve; y_curve; z_curve];
segment_color = [0 0 1];
if ~onlysimple
    scatter3(curve_cart(1,:), curve_cart(2,:), curve_cart(3,:),20,'filled','MarkerEdgeColor','none',...
        'MarkerFaceColor',segment_color)
end
%% Draw Tau-frame
M_tauW = [-sin(lat) .* cos(long), -sin(lat) .* sin(long), cos(lat);
          -sin(long)            , cos(long)             , 0;
          -cos(lat) .* cos(long), -cos(lat) .* sin(long), -sin(lat) ];

if onlysimple
    scale_factor = 60;
    linewidth = 2;
else
    scale_factor = 40;
    linewidth = 3;
end

      
x_tau = scale_factor * M_tauW' * [1; 0; 0];
y_tau = scale_factor * M_tauW' * [0; 1; 0];
z_tau = scale_factor * M_tauW' * [0; 0; 1];
tau_color = [0.588235294117647 0.301960784313725 0.819607843137255];
quiver3(x,y,z,x_tau(1),x_tau(2),x_tau(3), 'Color',tau_color,'LineWidth',linewidth)
quiver3(x,y,z,y_tau(1),y_tau(2),y_tau(3), 'Color',tau_color,'LineWidth',linewidth)
quiver3(x,y,z,z_tau(1),z_tau(2),z_tau(3), 'Color',tau_color,'LineWidth',linewidth)

%% Draw Gamma-frame
if iscell(t_W)
    t_W = scale_factor * cell2mat(t_W);
else
    t_W = scale_factor * t_W;
end
if iscell(t_rot_W)
    t_rot_W = cell2mat(t_rot_W);
end

gamma_color = [0.929411764705882 0.690196078431373 0.129411764705882];
if ~onlysimple
    quiver3(x,y,z,t_W(1),t_W(2),t_W(3), 'Color',gamma_color,'LineWidth',linewidth)
    %quiver3(x,y,z,t_rot_W(1),t_rot_W(2),t_rot_W(3), 'Color','g','LineWidth',3)
end

[long_noSigma, lat_noSigma, ~, ~, ~, t_rot_W_noSigma] = getLongLat(s, 0, h);
if iscell(t_rot_W_noSigma)
    t_rot_W_noSigma = cell2mat(t_rot_W_noSigma);
end

[x_noSigma, y_noSigma, z_noSigma] = sph2cart(long_noSigma, lat_noSigma, h);
[long_dot_noSigma, lat_dot_noSigma, ~] = vel_cart2sph(x_noSigma, y_noSigma, z_noSigma, ...
    t_rot_W_noSigma(1)/norm(t_rot_W_noSigma),t_rot_W_noSigma(2)/norm(t_rot_W_noSigma),t_rot_W_noSigma(3)/norm(t_rot_W_noSigma));
X_initial_noSigma = [long_noSigma, long_dot_noSigma, lat_noSigma, lat_dot_noSigma];

[long_dot, lat_dot, ~] = vel_cart2sph(x, y, z, ...
    t_rot_W(1)/norm(t_rot_W),t_rot_W(2)/norm(t_rot_W),t_rot_W(3)/norm(t_rot_W));
X_initial = [long, long_dot, lat, lat_dot];

% Plot fll curve
options = odeset('MaxStep', 5);
[t,X]=ode23s(@cir,[0,h*2*pi],X_initial_noSigma, options);
u=X(:,1);
v=X(:,3);
[x_geo, y_geo, z_geo] = sph2cart(u, v, h);
if ~onlysimple
    scatter3(x_geo, y_geo, z_geo, 20,gamma_color,'filled', 'MarkerEdgeColor','none','MarkerFaceAlpha',0.7)
end

% Plot sigma segment
sigma_color = [0.1 0.1 0.8];
options = odeset('MaxStep', 1);
[t,X]=ode23s(@cir,[0,sigma],X_initial_noSigma, options);
u=X(:,1);
v=X(:,3);
[x_geo, y_geo, z_geo] = sph2cart(u, v, h);
if ~onlysimple
    scatter3(x_geo, y_geo, z_geo, 20,sigma_color,'filled', 'MarkerEdgeColor','none','MarkerFaceAlpha',0.7)
end

% Plot y-axis
options = odeset('MaxStep', 1);
[t,X]=ode23s(@cir,[0,40],X_initial, options);
u=X(:,1);
v=X(:,3);
[x_geo, y_geo, z_geo] = sph2cart(u, v, h);
if ~onlysimple
    scatter3(x_geo, y_geo, z_geo, 20,gamma_color,'filled', 'MarkerEdgeColor','none','MarkerFaceAlpha',0.7)
end

% Plot tangent
tangent_color = 'g';
if ~onlysimple
    quiver3(x_noSigma,y_noSigma,z_noSigma,t_W(1),t_W(2),t_W(3), 'Color',tangent_color,'LineWidth',linewidth, 'LineStyle','-.')
    quiver3(x_noSigma,y_noSigma,z_noSigma,-t_W(1),-t_W(2),-t_W(3), 'Color',tangent_color,'LineWidth',linewidth, 'LineStyle','-.')
end
%% Add further annotation
if onlysimple
    Va      = 31;
    chi_a   = 0.5477;
    gamma_a = 0.1873;
    alpha = 0.12;
    mu_a = 0.3;
    visualize([long(1), lat(1), h_tau(1), Va(1), chi_a(1), gamma_a(1)], [alpha; mu_a], pi, 30)
    view(axes1,[110.390966695156 13.3111826444361]);

    initialState = [s, sigma, h_tau, Va, chi_a, gamma_a, 0]';
    sys = AWE_3DOF(initialState);
    [pos_G_W_x,pos_G_W_y,pos_G_W_z] = sph2cart(long,lat,h_tau);
    p_kite_W = {pos_G_W_x;pos_G_W_y;pos_G_W_z};
    scale = 60;
    arcfunc_args.scale = 0.92*scale;
    %% Plot NED frame
    NED_color = [0 0.4470 0.7410];
    M_WO = {cos(sys.ENVMT.windDirection_rad), sin(sys.ENVMT.windDirection_rad), 0;
        sin(sys.ENVMT.windDirection_rad), -cos(sys.ENVMT.windDirection_rad), 0;
        0, 0, -1};
    NED_ax_W_x = mult_cellMatrix(M_WO, [scale; 0; 0]);
    NED_ax_W_y = mult_cellMatrix(M_WO, [0; scale; 0]);
    NED_ax_W_z = mult_cellMatrix(M_WO, [0; 0; scale]);
    quiver3(p_kite_W{1},p_kite_W{2},p_kite_W{3},NED_ax_W_x{1},NED_ax_W_x{2},NED_ax_W_x{3}, 'LineWidth', linewidth, 'Color', NED_color)
    quiver3(p_kite_W{1},p_kite_W{2},p_kite_W{3},NED_ax_W_y{1},NED_ax_W_y{2},NED_ax_W_y{3}, 'LineWidth', linewidth, 'Color', NED_color)
    quiver3(p_kite_W{1},p_kite_W{2},p_kite_W{3},NED_ax_W_z{1},NED_ax_W_z{2},NED_ax_W_z{3}, 'LineWidth', linewidth, 'Color', NED_color)
    
    arcfunc_args.M = M_WO;
    arcfunc_args.theta = 2*pi;
    arc_points = arc_func(p_kite_W, 'xy', arcfunc_args);
    plot3(arc_points(1,:), arc_points(2,:), arc_points(3,:), 'LineWidth', linewidth, 'Color', NED_color, 'LineStyle', '-.')
    
    % Create textbox
    annotation(figure1,'textbox',...
        [0.779645833333329 0.562194036493108 0.032928571428571 0.054761904761905],...
        'Color',NED_color,...
        'String','$x_O$',...
        'Interpreter','latex',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');

    % Create textbox
    annotation(figure1,'textbox',...
        [0.796684523809518 0.502618305889343 0.0329285714285711 0.0547619047619052],...
        'Color',NED_color,...
        'String','$y_O$',...
        'Interpreter','latex',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');
    
    % Create textbox
    annotation(figure1,'textbox',...
        [0.694080357142852 0.366585076398169 0.0329285714285711 0.054761904761905],...
        'Color',NED_color,...
        'String','$z_O$',...
        'Interpreter','latex',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');
    %% Plot B frame
    B_color = [0.6350 0.0780 0.1840];
    beta = 0;
    M_AB = {cos(alpha) .* cos(beta), sin(beta), sin(alpha) .* cos(beta); 
            -cos(alpha) .* sin(beta), cos(beta), -sin(alpha) .* sin(beta); 
            -sin(alpha), 0, cos(alpha)};
    M_AbarO = {cos(chi_a) .* cos(gamma_a), sin(chi_a) .* cos(gamma_a), -sin(gamma_a); 
              -sin(chi_a),                 cos(chi_a),                             0; 
               cos(chi_a) .* sin(gamma_a), sin(chi_a) .* sin(gamma_a), cos(gamma_a)};
    M_OAbar = transpose_cellMatrix(M_AbarO);

    M_WAbar = mult_cellMatrix(M_WO, M_OAbar);

    M_AbarA = {1,0,0; 
           0, cos(mu_a), -sin(mu_a); 
           0, sin(mu_a), cos(mu_a)};
    M_WA = mult_cellMatrix(M_WAbar, M_AbarA);
    
    M_WB = mult_cellMatrix(M_WA, M_AB);
    B_ax_W_x = mult_cellMatrix(M_WB, [scale; 0; 0]);
    B_ax_W_y = mult_cellMatrix(M_WB, [0; scale; 0]);
    B_ax_W_z = mult_cellMatrix(M_WB, [0; 0; scale]);
    quiver3(p_kite_W{1},p_kite_W{2},p_kite_W{3},B_ax_W_x{1},B_ax_W_x{2},B_ax_W_x{3}, 'LineWidth', linewidth, 'Color', B_color, 'LineStyle', '-')
    quiver3(p_kite_W{1},p_kite_W{2},p_kite_W{3},B_ax_W_y{1},B_ax_W_y{2},B_ax_W_y{3}, 'LineWidth', linewidth, 'Color', B_color, 'LineStyle', ':')
    quiver3(p_kite_W{1},p_kite_W{2},p_kite_W{3},B_ax_W_z{1},B_ax_W_z{2},B_ax_W_z{3}, 'LineWidth', linewidth, 'Color', B_color, 'LineStyle', '-')
    
    arcfunc_args.M = M_WB;
    arcfunc_args.theta = 2*pi;
    arc_points = arc_func(p_kite_W, 'xy', arcfunc_args);
    plot3(arc_points(1,:), arc_points(2,:), arc_points(3,:), 'LineWidth', linewidth, 'Color', B_color, 'LineStyle', '-.')
    % Create textbox
    annotation(figure1,'textbox',...
        [0.810598214285703 0.605384957721421 0.032928571428571 0.054761904761905],...
        'Color',B_color,...
        'String','$x_B$',...
        'Interpreter','latex',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');
    
    % Create textbox
    annotation(figure1,'textbox',...
        [0.737309523809518 0.371673342234097 0.032928571428571 0.0547619047619059],...
        'Color',B_color,...
        'String','$z_B$',...
        'Interpreter','latex',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');


    % Create textbox
    annotation(figure1,'textbox',...
        [0.653719039356166 0.395522586340575 0.027971028971029 0.0384615384615383],...
        'String','$h_\tau$',...
        'Interpreter','latex',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');

    % Create textbox
    annotation(figure1,'textbox',...
        [0.724576824812832 0.336964610446237 0.0279710289710289 0.0384615384615383],...
        'String','$\phi$',...
        'Interpreter','latex',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');

    % Create textbox
    annotation(figure1,'textbox',...
        [0.581344031486756 0.153949006168315 0.027971028971029 0.0384615384615383],...
        'String','$\lambda$',...
        'Interpreter','latex',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');
    
    % Create textbox
    annotation(figure1,'textbox',...
        [0.401291895604396 0.155613067773683 0.027971028971029 0.0384615384615383],...
        'String','$x_W$',...
        'Interpreter','latex',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');
    
    % Create textbox
    annotation(figure1,'textbox',...
        [0.877426889859726 0.269548393176618 0.027971028971029 0.0384615384615383],...
        'String','$y_W$',...
        'Interpreter','latex',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');

    % Create textbox
    annotation(figure1,'textbox',...
        [0.628326239266539 0.867734075861661 0.027971028971029 0.0384615384615382],...
        'String','$z_W$',...
        'Interpreter','latex',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');

    % Create textbox
    annotation(figure1,'textbox',...
        [0.694229166666663 0.684727785195082 0.032928571428571 0.054761904761905],...
        'Color',tau_color,...
        'String','$x_\tau$',...
        'Interpreter','latex',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');

    % Create textbox
    annotation(figure1,'textbox',...
        [0.818187499999995 0.54661771250557 0.032928571428571 0.054761904761905],...
        'Color',tau_color,...
        'String','$y_\tau$',...
        'Interpreter','latex',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');
    
    % Create textbox
    annotation(figure1,'textbox',...
        [0.679124999999996 0.437583444592797 0.032928571428571 0.054761904761905],...
        'Color',tau_color,...
        'String','$z_\tau$',...
        'Interpreter','latex',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');

else
    view(axes1,[108.903466695156 14.0976794597227]);
    hold(axes1,'off');
    % Create textbox
    annotation(figure1,'textbox',...
        [0.75061486482009 0.408102692564992 0.0279710289710291 0.0384615384615382],...
        'String','t',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');
    
    % Create textbox
    annotation(figure1,'textbox',...
        [0.722142642597867 0.488158872340272 0.027971028971029 0.0384615384615382],...
        'String','\sigma',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');
    
    % Create textbox
    annotation(figure1,'textbox',...
        [0.873260223193059 0.290316825160004 0.027971028971029 0.0384615384615383],...
        'String','y_W',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');
    
    % Create textbox
    annotation(figure1,'textbox',...
        [0.419521062271062 0.161843597368698 0.027971028971029 0.0384615384615383],...
        'String','x_W',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');
    
    % Create textbox
    annotation(figure1,'textbox',...
        [0.579781531486756 0.158102692564992 0.027971028971029 0.0384615384615383],...
        'String','\lambda',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');
    
    % Create textbox
    annotation(figure1,'textbox',...
        [0.737597658146166 0.31931144326036 0.0279710289710289 0.0384615384615383],...
        'String','\phi',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');
    
    % Create textbox
    annotation(figure1,'textbox',...
        [0.646948206022833 0.400714694336422 0.027971028971029 0.0384615384615383],...
        'String','h_\tau',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');
    
    % Create textbox
    annotation(figure1,'textbox',...
        [0.617909572599873 0.882271978250031 0.027971028971029 0.0384615384615382],...
        'String','z_W',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');
    
    % Create textbox
    annotation(figure1,'textbox',...
        [0.675614864820091 0.732540894812183 0.0279710289710291 0.0384615384615382],...
        'String','s',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');
    
    % Create textbox
    annotation(figure1,'textbox',...
        [0.700185919801591 0.655637537998768 0.0279710289710291 0.0384615384615382],...
        'String','x_\tau',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');
    
    % Create textbox
    annotation(figure1,'textbox',...
        [0.781728651530891 0.557820300594564 0.027971028971029 0.0384615384615383],...
        'String','y_\tau',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');
    
    % Create textbox
    annotation(figure1,'textbox',...
        [0.732120113302949 0.651360997454411 0.0279710289710291 0.0384615384615382],...
        'String','y_\Gamma',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');
    
    % Create textbox
    annotation(figure1,'textbox',...
        [0.670312300469019 0.550912580941655 0.0279710289710291 0.0384615384615383],...
        'String','x_\Gamma',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');
    
    % Create textbox
    annotation(figure1,'textbox',...
        [0.712420420375645 0.423552130767238 0.027971028971029 0.0384615384615382],...
        'String','C',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');
    
    % Create textbox
    annotation(figure1,'textbox',...
        [0.727003753708978 0.523271231890833 0.027971028971029 0.0384615384615382],...
        'String','K',...
        'FontSize',30,...
        'FitBoxToText','off',...
        'EdgeColor','none');
end
%% Function definitions

function xp = cir(t,x)
    xp = zeros(4,1);
    xp(1) = x(2);
    xp(2) = 2*tan(x(3))*x(2)*x(4);
    xp(3) = x(4);
    xp(4) = -sin(x(3))*cos(x(3))*x(2)^2;
end
function [points] = arc_func(PoI, plane, extraArgs)
    if nargin < 3
        extraArgs = [];
    end
    
    if isfield(extraArgs, 'scale')
        scale = extraArgs.scale;
    else
        scale = 10;
    end

    if isfield(extraArgs, 'theta')
        theta = extraArgs.theta;
    else
        theta = 2*pi;
    end

    if isfield(extraArgs, 'nrpoints')
        nrpoints = extraArgs.nrpoints;
    else
        nrpoints = 500;
    end

    if isfield(extraArgs, 'M')
        M_frame = extraArgs.M;
        if iscell(M_frame)
            M_frame = cell2mat(M_frame);
        end
    else
        M_frame = eye(3);
    end
    if iscell(PoI)
        PoI = cell2mat(PoI);
    end
    switch plane
        case {'xy','yx'}
            M_rot = @(t) [cos(t), -sin(t), 0; ...
                     sin(t), cos(t), 0; ...
                     0, 0, 1];
            vec = [scale; 0; 0];
        case {'xz','zx'}
            M_rot = @(t) [cos(t), 0, sin(t); ...
                     0, 1, 0; ...
                     -sin(t), 0, cos(t)];
            vec = [scale; 0; 0];
        case {'yz','zy'}
            M_rot = @(t) [1, 0, 0; ...
                     0, cos(t), -sin(t); ...
                     0, sin(t), cos(t)];
            vec = [0; scale; 0];
        otherwise
            error('unknown plane')
    end
    points = zeros(3, nrpoints);
    for i = 1:nrpoints
        points(:,i) = PoI + M_frame * M_rot(i * theta/nrpoints) * vec;
    end
    
end